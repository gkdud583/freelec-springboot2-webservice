# ë¬´ì¤‘ë‹¨ ë°°í¬ ğŸ“Œ

ë¬´ì¤‘ë‹¨ ë°°í¬ì—ëŠ” ëª‡ê°€ì§€ ë°©ì‹ì´ ìˆì§€ë§Œ ê·¸ì¤‘ì—ì„œ Nginxë¥¼ ì´ìš©í•˜ì—¬ ë¬´ì¤‘ë‹¨ ë°°í¬ë¥¼ ì§„í–‰í•œë‹¤.

* AWSì—ì„œ ë¸”ë£¨ ê·¸ë¦°(Blue-Green) ë¬´ì¤‘ë‹¨ ë°°í¬
* ë„ì»¤ë¥¼ ì´ìš©í•œ ì›¹ì„œë¹„ìŠ¤ ë¬´ì¤‘ë‹¨ ë°°í¬

## Nginx?
ì›¹ ì„œë²„, ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ, ìºì‹±, ë¡œë“œ ë°¸ëŸ°ì‹±, ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¬ë° ë“±ì„ ìœ„í•œ ì˜¤í”ˆì†ŒìŠ¤ ì†Œí”„íŠ¸ì›¨ì–´.

ì—”ì§„ì—‘ìŠ¤ê°€ ê°€ì§„ ì—¬ëŸ¬ ê¸°ëŠ¥ ì¤‘, ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œë¼ëŠ” ê¸°ëŠ¥ì´ ìˆë‹¤.

ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œëŠ” ì—”ì§„ì—‘ìŠ¤ê°€ ì™¸ë¶€ì˜ ìš”ì²­ì„ ë°›ì•„ ë°±ì—”ë“œ ì„œë²„ë¡œ ìš”ì²­ì„ ì „ë‹¬í•˜ëŠ” í–‰ìœ„ë¥¼ ì´ì•¼ê¸°í•œë‹¤.
ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ì„œë²„(ì—”ì§„ì—‘ìŠ¤)ëŠ” ìš”ì²­ì„ ì „ë‹¬í•˜ê³ , ì‹¤ì œ ìš”ì²­ì— ëŒ€í•œ ì²˜ë¦¬ëŠ” ë’·ë‹¨ì˜ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ ì„œë²„ë“¤ì´ ì²˜ë¦¬í•œë‹¤.

## Nginx ë¬´ì¤‘ë‹¨ ë°°í¬ 
êµ¬ì¡°ëŠ” í•˜ë‚˜ì˜ EC2 í˜¹ì€ ë¦¬ëˆ…ìŠ¤ ì„œë²„ì— ì—”ì§„ì—‘ìŠ¤ 1ëŒ€ì™€ ìŠ¤í”„ë§ ë¶€íŠ¸ Jarë¥¼ 2ëŒ€ ì‚¬ìš©í•˜ëŠ”ê²ƒ.

* ì—”ì§„ì—‘ìŠ¤ëŠ” 80(http), 443(https) í¬íŠ¸ë¥¼ í• ë‹¹
* ìŠ¤í”„ë§ ë¶€íŠ¸1ì€ 8081í¬íŠ¸ë¡œ ì‹¤í–‰
* ìŠ¤í”„ë§ ë¶€íŠ¸2ëŠ” 8082í¬íŠ¸ë¡œ ì‹¤í–‰

    ###ìš´ì˜ê³¼ì •
1. ì‚¬ìš©ìëŠ” ì„œë¹„ìŠ¤ ì£¼ì†Œë¡œ ì ‘ì†(80 í˜¹ì€ 443 í¬íŠ¸)
2. ì—”ì§„ì—‘ìŠ¤ëŠ” ì‚¬ìš©ìì˜ ìš”ì²­ì„ ë°›ì•„ í˜„ì¬ ì—°ê²°ëœ ìŠ¤í”„ë§ ë¶€íŠ¸ë¡œ ìš”ì²­ì„ ì „ë‹¬
   ìŠ¤í”„ë§ ë¶€íŠ¸1 ì¦‰, 8081 í¬íŠ¸ë¡œ ìš”ì²­ì„ ì „ë‹¬í•œë‹¤ê³  ê°€ì •.
3. ìŠ¤í”„ë§ ë¶€íŠ¸2ëŠ” ì—”ì§„ì—‘ìŠ¤ì™€ ì—°ê²°ëœ ìƒíƒœê°€ ì•„ë‹ˆë¯€ë¡œ ìš”ì²­ë°›ì§€ ëª»í•œë‹¤.

**1.1ë²„ì „ìœ¼ë¡œ ì‹ ê·œ ë°°í¬ê°€ í•„ìš”í•˜ë‹¤ë©´?**  
ì—”ì§„ì—‘ìŠ¤ì™€ ì—°ê²°ë˜ì§€ ì•Šì€ ìŠ¤í”„ë§ ë¶€íŠ¸2(8080í¬íŠ¸)ë¡œ ë°°í¬í•œë‹¤.

1. ë°°í¬í•˜ëŠ” ë™ì•ˆì—ëŠ” ì„œë¹„ìŠ¤ëŠ” ì¤‘ë‹¨ë˜ì§€ ì•ŠëŠ”ë‹¤. ì—”ì§„ì—‘ìŠ¤ëŠ” ìŠ¤í”„ë§ ë¶€íŠ¸1ì„ ë°”ë¼ë³´ê¸° ë•Œë¬¸.
2. ë°°í¬ê°€ ëë‚˜ê³  ì •ìƒì ìœ¼ë¡œ ìŠ¤í”„ë§ë¶€íŠ¸2ê°€ êµ¬ë™ ì¤‘ì¸ì§€ í™•ì¸.
3. ìŠ¤í”„ë§ ë¶€íŠ¸2ê°€ ì •ìƒ êµ¬ë™ ì¤‘ì´ë©´ nginx reload ëª…ë ¹ì–´ë¥¼ í†µí•´ 8081ëŒ€ì‹ ì— 8082ë¥¼ ë°”ë¼ë³´ê²Œ í•œë‹¤.
4. nginx reloadëŠ” 0.1ì´ˆ ì´ë‚´ì— ì™„ë£Œëœë‹¤.

**ì´í›„ 1.2ë²„ì „ ë°°í¬ê°€ í•„ìš”í•˜ë©´ ì´ë²ˆì—ëŠ” ìŠ¤í”„ë§ ë¶€íŠ¸1ë¡œ ë°°í¬í•œë‹¤**
1. í˜„ì¬ëŠ” ì—”ì§„ì—‘ìŠ¤ì™€ ì—°ê²°ëœ ê²ƒì´ ìŠ¤í”„ë§ ë¶€íŠ¸2
2. ìŠ¤í”„ë§ ë¶€íŠ¸1ì˜ ë°°í¬ê°€ ëë‚¬ë‹¤ë©´ ì—”ì§„ì—‘ìŠ¤ê°€ ìŠ¤í”„ë§ ë¶€íŠ¸1ì„ ë°”ë¼ë³´ë„ë¡ ë³€ê²½í•˜ê³  nginx reloadë¥¼ ì‹¤í–‰í•œë‹¤.
3. ì´í›„ ìš”ì²­ë¶€í„°ëŠ” ì—”ì§„ì—‘ìŠ¤ê°€ ìŠ¤í”„ë§ ë¶€íŠ¸1ë¡œ ìš”ì²­ì„ ì „ë‹¬í•œë‹¤.

![img_7.png](img_7.png)
https://jojoldu.tistory.com/267

## ì—”ì§„ì—‘ìŠ¤ ì„¤ì¹˜ì™€ ìŠ¤í”„ë§ ë¶€íŠ¸ ì—°ë™
* EC2ì— ì—”ì§„ì—‘ìŠ¤ ì„¤ì¹˜
* ë³´ì•ˆê·¸ë£¹ ì¶”ê°€  
ì—”ì§„ì—‘ìŠ¤ì˜ ê¸°ë³¸í¬íŠ¸ëŠ” 80. í•´ë‹¹ í¬íŠ¸ ë²ˆí˜¸ê°€ ë³´ì•ˆ ê·¸ë£¹ì— ì—†ìœ¼ë‹ˆ ë³´ì•ˆê·¸ë£¹ì— ì¶”ê°€.
* ë¦¬ë‹¤ì´ë ‰ì…˜ ì£¼ì†Œ ì¶”ê°€  
8080ì´ ì•„ë‹Œ 80í¬íŠ¸ë¡œ ì£¼ì†Œê°€ ë³€ê²½ë˜ë‹ˆ êµ¬ê¸€ê³¼ ë„¤ì´ë²„ ë¡œê·¸ì¸ì—ë„ ë³€ê²½ëœ ì£¼ì†Œë¥¼ ë“±ë¡í•´ì•¼ í•œë‹¤.
* ì—”ì§„ì—‘ìŠ¤ì™€ ìŠ¤í”„ë§ ë¶€íŠ¸ ì—°ë™  
ì—”ì§„ì—‘ìŠ¤ê°€ í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ìŠ¤í”„ë§ ë¶€íŠ¸ í”„ë¡œì íŠ¸ë¥¼ ë°”ë¼ë³¼ ìˆ˜ ìˆë„ë¡ í”„ë¡ì‹œ ì„¤ì •ì„ í•œë‹¤.
ì—”ì§„ì—‘ìŠ¤ ì„¤ì • íŒŒì¼ì„ ì—´ì–´ ë‹¤ìŒì˜ ë‚´ìš©ì„ ì¶”ê°€
  
```conf
proxy_pass http://localhost:8080; // ì—”ì§„ì—‘ìŠ¤ë¡œ ìš”ì²­ì´ ì˜¤ë©´ í•´ë‹¹ ì£¼ì†Œë¡œ ì „ë‹¬
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header Host $http_host;

```

proxy_set_header XXX  
ì‹¤ì œ ìš”ì²­ ë°ì´í„°ë¥¼ headerì˜ ê° í•­ëª©ì— í• ë‹¹í•œë‹¤.  

     proxy_set_header X-Real-IP $remote_addr; -> Request Headerì˜ X-Real-IPì— ìš”ì²­ìì˜ IPë¥¼ ì €ì¥.
     
## ë¬´ì¤‘ë‹¨ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ë§Œë“¤ê¸°
### profile APIì¶”ê°€
ì´í›„ ë°°í¬ì‹œì— 8081ì„ ì“¸ì§€, 8082ë¥¼ ì“¸ì§€ íŒë‹¨í•˜ëŠ” ê¸°ì¤€ì´ ëœë‹¤.

```java
@RequiredArgsConstructor
@RestController
public class ProfileController {
    private final Environment env;

    @GetMapping("/profile")
    public String profile() {
        List<String> profiles = Arrays.asList(env.getActiveProfiles()); //í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ActiveProfileì„ ëª¨ë‘ ê°€ì ¸ì˜¨ë‹¤
        List<String> realProfiles = Arrays.asList("real", "real1", "real2");
        String defaultProfile = profiles.isEmpty()? "default" : profiles.get(0);

        return profiles.stream()
                .filter(realProfiles::contains)
                .findAny()
                .orElse(defaultProfile); 
        //real, real1, real2ëŠ” ëª¨ë‘ ë°°í¬ì—ì„œ ì‚¬ìš©ë  profileì´ë¼ ì´ ì¤‘ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ ê·¸ ê°’ì„ ë°˜í™˜í•˜ë„ë¡ í•œë‹¤.
        
        
    }
}
```

í•´ë‹¹ ì½”ë“œê°€ ì˜ ë™ì‘í•˜ëŠ”ì§€ í™•ì¸í•˜ê¸° ìœ„í•œ í…ŒìŠ¤íŠ¸ ì½”ë“œ  
Environmentë¥¼ ìƒì„±ì ì£¼ì… ë°›ì•˜ê¸° ë•Œë¬¸ì— ìŠ¤í”„ë§ í…ŒìŠ¤íŠ¸ ì—†ì´ í…ŒìŠ¤íŠ¸ í• ìˆ˜ ìˆë‹¤.
```java
public class ProfileControllerUnitTest {

    @Test
    public void real_profileì´_ì¡°íšŒëœë‹¤() {
        //given
        String expectedProfile = "real";
        MockEnvironment env = new MockEnvironment();
        env.addActiveProfile(expectedProfile);
        env.addActiveProfile("oauth");
        env.addActiveProfile("real-db");

        ProfileController controller = new ProfileController(env);

        //when
        String profile = controller.profile();

        //then
        assertThat(profile).isEqualTo(expectedProfile);
    }

    @Test
    public void real_profileì´_ì—†ìœ¼ë©´_ì²«ë²ˆì§¸ê°€_ì¡°íšŒëœë‹¤() {
        //given
        String expectedProfile = "oauth";
        MockEnvironment env = new MockEnvironment();

        env.addActiveProfile(expectedProfile);
        env.addActiveProfile("real-db");

        ProfileController controller = new ProfileController(env);

        //when
        String profile = controller.profile();

        //then
        assertThat(profile).isEqualTo(expectedProfile);
    }

    @Test
    public void active_profileì´_ì—†ìœ¼ë©´_defaultê°€_ì¡°íšŒëœë‹¤() {
        //given
        String expectedProfile = "default";
        MockEnvironment env = new MockEnvironment();
        ProfileController controller = new ProfileController(env);

        //when
        String profile = controller.profile();

        //then
        assertThat(profile).isEqualTo(expectedProfile);
    }
}
```

/profileì´ ì¸ì¦ ì—†ì´ë„ í˜¸ì¶œë ìˆ˜ ìˆê²Œ SecurityConfig í´ë˜ìŠ¤ì— ì œì™¸ ì½”ë“œë¥¼ ì¶”ê°€í•œë‹¤.
```java
antMatchers("/", "/css/**", "/images/**", "/js/**", "/h2-console/**", "/profile").permitAll()

```        

SecurityConfig ì„¤ì •ì´ ì˜ ë˜ì—ˆëŠ”ì§€ë„ í…ŒìŠ¤íŠ¸ ì½”ë“œë¡œ ê²€ì¦í•œë‹¤.
ì´ ê²€ì¦ì€ ìŠ¤í”„ë§ ì‹œíë¦¬í‹° ì„¤ì •ì„ ë¶ˆëŸ¬ì™€ì•¼ í•˜ë‹ˆ @SpringBootTestë¶™ì„

```java
@RunWith(SpringRunner.class)
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
public class ProfileControllerTest {

    @LocalServerPort
    private int port;

    @Autowired
    private TestRestTemplate restTemplate;

    @Test
    public void profileì€_ì¸ì¦ì—†ì´_í˜¸ì¶œëœë‹¤() throws Exception {
        String expected = "default";

        ResponseEntity<String> response = restTemplate.getForEntity("/profile", String.class);
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(response.getBody()).isEqualTo(expected);
    }
}

```

### real1, real2 profile ìƒì„±
í˜„ì¬ EC2í™˜ê²½ì—ì„œ ì‹¤íš…ë˜ëŠ” profileì€ realë°–ì— ì—†ë‹¤. í•´ë‹¹ profileì€ Travis CI ë°°í¬ ìë™í™”ë¥¼ ìœ„í•œ
profileì´ê¸° ë•Œë¬¸ì— ë¬´ì¤‘ë‹¨ ë°°í¬ë¥¼ ìœ„í•œ profile 2ê°œë¥¼ /src/main/resources ì•„ë˜ì— ì¶”ê°€í•œë‹¤.

application-real1.properties
```properties
server.port=8081
spring.profiles.include=oauth,real-db
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQL5InnoDBDialect
spring.session.store-type=jdbc

```

application-real2.properties
```properties
server.port=8082
spring.profiles.include=oauth,real-db
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQL5InnoDBDialect
spring.session.store-type=jdbc

```

2ê°œì˜ profileì€ real profileê³¼ í¬ê²Œ ë‹¤ë¥¸ ì ì€ ì—†ì§€ë§Œ, server.portê°€ 8080ì´ ì•„ë‹Œ 8081/8082ë¡œ ë˜ì–´ ìˆë‹¤.

### ì—”ì§„ì—‘ìŠ¤ ì„¤ì • ìˆ˜ì •
ë¬´ì¤‘ë‹¨ ë°°í¬ì˜ í•µì‹¬ì€ ì—”ì§„ì—‘ìŠ¤ ì„¤ì •.
ë°°í¬ ë•Œë§ˆë‹¤ ì—”ì§„ì—‘ìŠ¤ì˜ í”„ë¡ì‹œ ì„¤ì •(ìŠ¤í”„ë§ ë¶€íŠ¸ë¡œ ìš”ì²­ì„ í˜ë ¤ë³´ë‚´ëŠ”)ì´ ìˆœì‹ê°„ì— êµì²´ëœë‹¤.

* /etc/nginx/conf.d/service-url.incë¼ëŠ” íŒŒì¼ í•˜ë‚˜ ìƒì„±í•´ ë‹¤ìŒ ì½”ë“œ ì…ë ¥
```
set $service_url http://127.0.0.1:8080;
```
* nginx.conf íŒŒì¼ì„ ì°¾ì•„ ë‹¤ìŒ ì½”ë“œë¡œ ë³€ê²½
```
include /etc/nginx/conf.d/sevice-url.inc;
proxy_pass $service_url;
```

### ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ë“¤ ì‘ì„±(ìƒëµ)
* stop.sh : ê¸°ì¡´ ì—”ì§„ì—‘ìŠ¤ì— ì—°ê²°ë˜ì–´ ìˆì§„ ì•Šì§€ë§Œ, ì‹¤í–‰ ì¤‘ì´ë˜ ìŠ¤í”„ë§ ë¶€íŠ¸ ì¢…ë£Œ
* start.sh : ë°°í¬í•  ì‹ ê·œ ë²„ì „ ìŠ¤í”„ë§ ë¶€íŠ¸ í”„ë¡œì íŠ¸ë¥¼ stop.shë¡œ ì¢…ë£Œí•œ 'profile'ë¡œ ì‹¤í–‰
* health.sh : 'start.sh'ë¡œ ì‹¤í–‰ì‹œí‚¨ í”„ë¡œì íŠ¸ê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ëëŠ”ì§€ ì²´í¬
* switch.sh : ì—”ì§„ì—‘ìŠ¤ê°€ ë°”ë¼ë³´ëŠ” ìŠ¤í”„ë§ ë¶€íŠ¸ë¥¼ ìµœì‹  ë²„ì „ìœ¼ë¡œ ë³€ê²½
* profile.sh : ì•ì„  4ê°œì˜ ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ì—ì„œ ê³µìš©ìœ¼ë¡œ ì‚¬ìš©í•  'profile'ê³¼ í¬íŠ¸ ì²´í¬ ë¡œì§
